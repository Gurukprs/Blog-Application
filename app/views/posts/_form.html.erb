<%= form_with model: [@topic, @post],
              data: { remote: true },
              html: { id: "post-form", class: "needs-validation" },
              multipart: true do |f| %>
  <% if @post.errors.any? %>
    <div class="alert alert-danger" id="error_explanation">
      <h5 class="alert-heading"><%= pluralize(@post.errors.count, "error") %> prohibited this post from being saved:</h5>
      <ul class="mb-0">
        <% @post.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row">
    <div class="col-md-12 mb-3">
      <%= f.label :title, class: "form-label" %>
      <%= f.text_field :title, class: "form-control #{'is-invalid' if @post.errors[:title].any?}" %>
      <% if @post.errors[:title].any? %>
        <div class="invalid-feedback">
          <%= @post.errors[:title].join(", ") %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12 mb-3">
      <%= f.label :body, class: "form-label" %>
      <%= f.text_area :body, rows: 10, class: "form-control #{'is-invalid' if @post.errors[:body].any?}" %>
      <% if @post.errors[:body].any? %>
        <div class="invalid-feedback">
          <%= @post.errors[:body].join(", ") %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12 mb-3">
      <%= f.label :image, "Post Image", class: "form-label" %>
      <% if @post.image.attached? %>
        <div class="mb-2">
          <%= image_tag @post.image, class: "img-thumbnail", style: "max-width: 300px; max-height: 300px;" %>
          <br>
          <small class="text-muted">Current image (upload new image to replace)</small>
        </div>
      <% end %>
      <%= f.file_field :image, accept: "image/*", class: "form-control #{'is-invalid' if @post.errors[:image].any?}" %>
      <% if @post.errors[:image].any? %>
        <div class="invalid-feedback">
          <%= @post.errors[:image].join(", ") %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12 mb-3">
      <%= f.label :tag_ids, "Choose Existing Tags", class: "form-label" %>
      <%= f.collection_select :tag_ids,
                            @available_tags,
                            :id,
                            :name,
                            { include_hidden: false },
                            { multiple: true, size: 5, class: "form-select #{'is-invalid' if @post.errors[:tag_ids].any?}" } %>
      <% if @post.errors[:tag_ids].any? %>
        <div class="invalid-feedback">
          <%= @post.errors[:tag_ids].join(", ") %>
        </div>
      <% end %>
      <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple tags.</small>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12 mb-3">
      <%= f.label :tags_attributes, "Add New Tags", class: "form-label" %>
      <div class="row g-2">
        <% 3.times do |index| %>
          <div class="col-md-4">
            <%= text_field_tag "post[tags_attributes][#{index}][name]", "", id: "post_tags_attributes_#{index}_name", placeholder: "e.g. ruby", class: "form-control" %>
          </div>
        <% end %>
      </div>
      <small class="form-text text-muted">Leave blank if you do not need new tags.</small>
    </div>
  </div>

  <div id="post-loading" class="alert alert-info" style="display:none;">Submitting...</div>

  <div class="row">
    <div class="col-md-12">
      <%= f.submit class: "btn btn-primary" %>
    </div>
  </div>
<% end %>
